<p>Nella recente gara Rails Rumble i partecipanti hanno provato a creare un&rsquo;applicazione Rails in 48 ore. La pagina di login alla competizione era interessante, perch&egrave; permetteva di autenticarsi mediante una serie di servizi differenti.</p>

<div class="imageWrapper">
  <img src="/system/photos/475/original/E233I01.png" width="804" height="716" alt="La pagina di login a Rails Rumble."/>
</div>

<p>Dare la possibilit&agrave, di autenticarsi mediante una serie di servizi differenti pu&ograve; richiedere uno sforzo notevole in termini di sviluppo, ma il sito Rails Rumble ha risolto il problema usando Janrain, che fornisce un servizio chiamato <a href="http://www.janrain.com/products/engage">Janrain Engage</a> (conosciuto anche come RPX). Si tratta di un servizio di autenticazione centralizzato; c&rsquo;&egrave; un API con cui una applicazione pu&ograve; comunicare per abilitare l&rsquo;autenticazione mediante una pletora di altri provider. Janrain &egrave; un servizio commerciale, ma ne esiste anche una versione gratuita, pi&ugrave; limitata, che va pi&ugrave; che bene per gli scopi di un sito come Rails Rumble.</p>

<h3>Autenticazione mediante Engage</h3>

<p>L&rsquo;autenticazione basilare mediante il servizio Janrain Engage &grave; semplice. Una volta registrati al servizio e aver fornito un nome per la nostra applicazione, veniamo portati alla home page del nostro account. Da qui dobbiamo prendere nota della chiave per le API e del nome dell&rsquo;applicazione, in questo caso &lsquo;asciicasts&rsquo;. Dobbiamo anche dichiarare i provider che desideriamo usare. Se ci autentichiamo e poi clicchiamo sul tab &lsquo;Providers&rsquo;, veniamo portati a una pagina da cui potremo scegliere i servizi attraverso i quali gli utenti della nostra applicazione potranno autenticarsi:</p>

<div class="imageWrapper">
  <img src="/system/photos/476/original/E233I02.png" width="802" height="582" alt="La scelta dei provider dei servizi di autenticazione  per la nostra applicazione."/>
</div>

<p>The free plan only allows use to choose six providers but that still gives us plenty of choice. Note that some of them require extra setup. To use Twitter, for example, we&rsquo;d need to set up our application as an OAuth client, but that&rsquo;s easy enough to do. For our application we&rsquo;ll stick with the four providers that are provided by default.</p>

<h3>Modifying our Application to use Engage</h3>

<p>Now that we&rsquo;re signed up we can use Engage in a Rails application. If we were creating authentication from scratch we could use the <a href="http://github.com/grosser/rpx_now">RPXNow</a> gem which offers a lot of functionality to help us use Engage in an application. If our application used Authlogic then there&rsquo;s an <a href="http://github.com/tardate/authlogic_rpx">Authlogic RPX</a> gem that is worth investigating. Finally there is the <a href="http://github.com/slainer68/devise_rpx_connectable">RPX Connectable</a> gem for use with Devise. The application we&rsquo;re working with in this episode uses Devise so we&rsquo;ll be using this last gem to embed Engage into it. If you&rsquo;re not familiar with Devise then take a look at episode 209 [<a href="http://railscasts.com/episodes/209-introducing-devise">watch</a>, <a href="http://asciicasts.com/episodes/209-introducing-devise">read</a>] for an introduction.</p>

<p>Our application already has &ldquo;Sign up&rdquo; and &ldquo;Sign in&rdquo; links and these take the user to a simple form that needs to be filled in with an email address and password.</p>

<div class="imageWrapper">
  <img src="/system/photos/477/original/E233I03.png" width="802" height="438" alt="Our application&rsquo;s current sign-in page."/>
</div>

<p>We want to replace these links with a single link that takes the user to a page where they can sign in via Engage and this is where we can make use of the RPX Connectable gem.</p> 

<p>To use the gem in our application we just need to add a reference to it the <code>Gemfile</code>.</p>

<p class="codeFilePath">/Gemfile</p>
<pre class="ruby">
source &#x27;http://rubygems.org&#x27;

gem &#x27;rails&#x27;, &#x27;3.0.0&#x27;
gem &#x27;sqlite3-ruby&#x27;, &#x27;1.2.5&#x27;, :require =&gt; &#x27;sqlite3&#x27;
gem &#x27;devise&#x27;
gem &#x27;nifty-generators&#x27;
gem &#x27;devise_rpx_connectable&#x27;
</pre>

<p>Then install it with</p>

<pre class="terminal">
$ bundle install
</pre>

<p>To use RPX we&rsquo;ll need to add an <code>rpx_identifier</code> field to our <code>Users</code> table. We&rsquo;ll generate a new migration to do this.</p>

<pre class="terminal">
$ rails g migration add_rpx_to_users rpx_identifier:string
</pre>

<p>We can then run the migration to  add the new field.</p>

<pre class="terminal">
$ rake db:migrate
</pre>

<p>Next we need to modify the call to <code>devise</code> in the <code>User</code> model so that it has <code>:rpx_connectable</code> in its list of modules.</p>

<p class="codeFilePath">/app/models/user.rb</p>
<pre class="ruby">
class User &lt; ActiveRecord::Base
  devise :database_authenticatable, :registerable, 
         :recoverable, :rememberable, :trackable, :validatable, :rpx_connectable

  # Setup accessible (or protected) attributes for your model
  attr_accessible :email, :password, :password_confirmation
end
</pre>

<p>Finally we have to update our application&rsquo;s Devise config file to specify the name we gave the application when we signed up for Engage, along with the API key we were given.</p>

<p class="codeFilePath">/config/initializers/devise.rb</p>
<pre class="ruby">
Devise.setup do |config|
  # Configure the e-mail address which will be shown in DeviseMailer.
  config.mailer_sender = &quot;test@example.com&quot;
  config.rpx_application_name = &#x27;asciicasts&#x27;
  RPXNow.api_key = &quot;aaabbbcccdddeeefff&quot; # real key goes here.
end
</pre>

<p>Now that we have everything set up we can replace our application&rsquo;s &ldquo;Sign up&rdquo; and &ldquo;Sign in&rdquo; links in the layout file with a link to the Engage signup page, passing in the URL we want to return to after signing in.</p>

<p class="codeFilePath">/app/views/layouts/application.html.erb</p>
<pre class="ruby">
&lt;%= link_to_rpx "Sign in", user_session_url %&gt;
</pre>

<h3>Logging In</h3>

<p>We now have the code in place to try logging in. When we click the &ldquo;Sign in&rdquo; link on our application we&rsquo;ll now be taken to a page on Janrain&rsquo;s server.</p>

<div class="imageWrapper">
  <img src="/system/photos/478/original/E233I04.png" width="814" height="444" alt="We can now sign in with Engage."/>
</div>

<p>We can now sign in using one of the accounts above and, assuming we enter our details correctly we&rsquo;ll be redirected back to our application.</p>

<div class="imageWrapper">
  <img src="/system/photos/479/original/E233I05.png" width="813" height="375" alt="Signed in successfully via Google."/>
</div>

<p>Note that we&rsquo;re now signed in to the application.</p>

<h3>A Better Login Page</h3>

<p>If we want the sign-in panel to be a cool JavaScript overlay instead of a separate page we can do so by including the following line of code just before the closing body tag on the layout page.</p> 

<p class="codeFilePath">/app/views/layouts/application.html.erb</p>
<pre class="ruby">
&lt;%= javascript_include_rpx(user_session_url) %&gt;
</pre>

<p>This will add some JavaScript to our application that shows an overlay on the site when a user tries to log in.</p>

<div class="imageWrapper">
  <img src="/system/photos/480/original/E233I06.png" width="813" height="413" alt="Using a popup panel to sign in"/>
</div>

<p>Alternatively we could embed the sign-in panel anywhere in our application by using an iframe. To do this all we need to do is to add the following line of code somewhere in the view code.</p>

<pre class="ruby">
&lt;%= embed_rpx user_session_url %&gt;
</pre>

<p>This code is best placed somewhere near the sign up or login forms to provide an alternative way to log in.</p>

<p>Everything we&rsquo;ve shown you in this episode is in the Devise RPX Connectable README file, along with some information about additional options that can be passed in so that we can request additional information about each logged-in user.</p>